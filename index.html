<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A retro pixel art weather application with real-time forecasts and interactive features">
  <meta name="theme-color" content="#181425">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUGl4ZWwgV2VhdGhlciIsInNob3J0X25hbWUiOiJQaXhlbFdlYXRoZXIiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzE4MTQyNSIsInRoZW1lX2NvbG9yIjoiIzVhM2E2OSIsImljb25zIjpbeyJzcmMiOiJpY29uLTcyeDcyLnBuZyIsInNpemVzIjoiNzJ4NzIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==" />
  <title>Pixel Weather</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    :root {
      --primary-color: #5a3a69;
      --primary-dark: #49306e;
      --background-color: #181425;
      --panel-color: #262b44;
      --text-color: #eef7fa;
      --text-secondary: #8b9bb4;
      --accent-color: #ff004d;
      --success-color: #97fb57;
      --rain-color: #8b9bb4;
      --sun-color: #fcdf59;
      --moon-color: #dfdfe4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Press Start 2P', cursive;
      background-color: var(--background-color);
      color: var(--text-color);
      height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      transition: background-color 1s ease;
    }

    .container {
      max-width: 800px;
      width: 100%;
      padding: 10px;
    }

    .header {
      text-align: center;
      padding: 20px 0;
      color: #eef7fa;
      text-shadow: 3px 3px #000;
    }

    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }

    #city-input {
      padding: 10px;
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      background-color: #736e7d;
      color: var(--text-color);
      border: 3px solid var(--primary-color);
      outline: none;
      width: 250px;
      transition: all 0.3s ease;
    }
    
    #city-input:focus {
      border-color: var(--primary-dark);
      box-shadow: 0 0 8px rgba(90, 58, 105, 0.6);
    }

    button {
      padding: 10px 15px;
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      cursor: pointer;
      border: 3px solid var(--primary-dark);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      background-color: var(--primary-dark);
      transform: scale(1.05);
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(45deg);
      transition: all 0.3s ease;
      opacity: 0;
    }
    
    button:hover::after {
      opacity: 1;
      top: -100%;
      left: -100%;
    }

    .weather-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background-color: #262b44;
      border: 5px solid #49306e;
      box-shadow: 10px 10px 0px #000;
      margin-bottom: 20px;
    }

    .weather-info {
      display: flex;
      width: 100%;
      justify-content: space-around;
      align-items: center;
      margin-top: 20px;
    }

    .temp-container {
      text-align: center;
    }

    .temperature {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .unit-toggle {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    .unit-btn {
      padding: 5px 10px;
      font-size: 10px;
      background-color: #3a4466;
      border: 2px solid #5a6988;
      margin: 0 5px;
    }

    .unit-btn.active {
      background-color: var(--primary-color);
      border-color: var(--primary-dark);
    }
    
    .air-quality {
      margin-top: 20px;
      padding: 15px;
      background-color: #3a4466;
      border: 3px solid #5a6988;
      width: 100%;
    }
    
    .aqi-meter {
      margin-top: 10px;
    }
    
    .aqi-value {
      font-size: 24px;
      text-align: center;
      margin-bottom: 5px;
    }
    
    .aqi-bar {
      height: 15px;
      background-color: #262b44;
      border: 2px solid #5a6988;
      margin-bottom: 5px;
    }
    
    .aqi-fill {
      height: 100%;
      width: 0%;
      background-color: #97fb57;
      transition: width 1s ease, background-color 1s ease;
    }
    
    .aqi-label {
      text-align: center;
      font-size: 12px;
    }
    
    .historical-chart {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--panel-color);
      border: 5px solid var(--primary-dark);
      box-shadow: 10px 10px 0px #000;
      width: 100%;
    }
    
    .location-sharing {
      margin-top: 20px;
    }
    
    .location-btn {
      background-color: #3a4466;
      border: 3px solid #5a6988;
    }
    
    .theme-toggle {
      margin-top: 10px;
      margin-bottom: 20px;
    }
    
    #offline-notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: var(--success-color);
      color: #000;
      border: 3px solid #000;
      animation: slide-in 0.5s ease;
    }
    
    @keyframes slide-in {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .details {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: 100%;
    }

    .detail-item {
      background-color: #3a4466;
      padding: 10px;
      text-align: center;
      border: 3px solid #5a6988;
    }

    .detail-label {
      font-size: 10px;
      color: #8b9bb4;
      margin-bottom: 5px;
    }

    .detail-value {
      font-size: 14px;
    }

    .weather-animation {
      width: 128px;
      height: 128px;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }

    .rain, .snow, .cloud, .sun, .moon, .stars {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    /* Rain animation */
    .raindrop {
      position: absolute;
      background-color: #8b9bb4;
      width: 2px;
      height: 10px;
      opacity: 0.7;
      animation: falling 1s linear infinite;
    }

    @keyframes falling {
      0% {
        transform: translateY(-10px);
      }
      100% {
        transform: translateY(128px);
      }
    }

    /* Snow animation */
    .snowflake {
      position: absolute;
      width: 4px;
      height: 4px;
      background-color: white;
      border-radius: 50%;
      opacity: 0.8;
      animation: snowfall 4s linear infinite;
    }

    @keyframes snowfall {
      0% {
        transform: translateY(-10px) translateX(0);
      }
      25% {
        transform: translateY(32px) translateX(5px);
      }
      50% {
        transform: translateY(64px) translateX(0);
      }
      75% {
        transform: translateY(96px) translateX(-5px);
      }
      100% {
        transform: translateY(128px) translateX(0);
      }
    }

    /* Cloud */
    .cloud {
      background-color: #8b9bb4;
      width: 70px;
      height: 30px;
      border-radius: 15px;
      top: 40px;
      left: 30px;
      box-shadow: 
        -15px -8px 0 0 #8b9bb4,
        15px -10px 0 0 #8b9bb4;
    }

    /* Sun */
    .sun {
      background-color: #fcdf59;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      top: 20px;
      left: 44px;
      box-shadow: 0 0 20px 5px #fcdf59;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Moon */
    .moon {
      background-color: #dfdfe4;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      top: 25px;
      left: 46px;
      box-shadow: -8px -2px 0 0 #262b44, 0 0 10px 2px #dfdfe4;
    }

    /* Stars */
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background-color: white;
      animation: twinkle 2s ease-in-out infinite;
    }

    @keyframes twinkle {
      0% {
        opacity: 0.2;
      }
      50% {
        opacity: 1;
      }
      100% {
        opacity: 0.2;
      }
    }

    .forecast-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
      margin-top: 20px;
      width: 100%;
    }

    .forecast-item {
      background-color: #262b44;
      padding: 10px;
      min-width: 120px;
      text-align: center;
      border: 3px solid #3a4466;
    }

    .forecast-day {
      font-size: 10px;
      margin-bottom: 5px;
    }

    .forecast-temp {
      font-size: 14px;
      margin: 5px 0;
    }

    .forecast-icon {
      width: 32px;
      height: 32px;
      margin: 5px auto;
      position: relative;
    }

    .error-message {
      color: #ff004d;
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    .loading {
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    .loading:after {
      content: ".";
      animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
      0%, 20% {
        content: ".";
      }
      40% {
        content: "..";
      }
      60% {
        content: "...";
      }
      80%, 100% {
        content: "";
      }
    }

    .api-notice {
      margin-top: 20px;
      text-align: center;
      font-size: 10px;
      color: #8b9bb4;
    }

    .hidden {
      display: none;
    }
    
    /* Dark mode / light mode themes */
    body.light-theme {
      --background-color: #eef7fa;
      --panel-color: #c0cbdc;
      --text-color: #181425;
      --text-secondary: #3a4466;
      color: var(--text-color);
    }
    
    body.light-theme .weather-display,
    body.light-theme .historical-chart {
      background-color: var(--panel-color);
      box-shadow: 10px 10px 0px #8b9bb4;
    }
    
    body.light-theme .detail-item {
      background-color: #8b9bb4;
      border-color: #3a4466;
    }
    
    body.light-theme .detail-label {
      color: #262b44;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 5px;
      }
      
      .search-container {
        flex-direction: column;
        align-items: center;
      }
      
      #city-input {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .weather-info {
        flex-direction: column;
      }
      
      .details {
        grid-template-columns: 1fr;
      }
      
      .forecast-container {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>SOL</h1>
    </div>

    <!-- API key is now set by the developer -->

    <div class="search-container">
      <input type="text" id="city-input" placeholder="Enter city name">
      <button id="search-button">Search</button>
    </div>

    <div class="loading">Loading weather data</div>
    <div class="error-message" id="error-message">Something went wrong</div>

    <div class="weather-display hidden" id="weather-container">
      <h2 id="city-name">City Name</h2>
      <div class="weather-animation" id="weather-animation">
        <!-- Weather animations will be inserted here -->
      </div>
      <h3 id="weather-description">Weather Description</h3>
      
      <div class="weather-info">
        <div class="temp-container">
          <div class="temperature" id="temperature">--°C</div>
          <div id="feels-like">Feels like: --°C</div>
          <div class="unit-toggle">
            <button id="celsius" class="unit-btn active">°C</button>
            <button id="fahrenheit" class="unit-btn">°F</button>
          </div>
        </div>
      </div>

      <div class="details">
        <div class="detail-item">
          <div class="detail-label">HUMIDITY</div>
          <div class="detail-value" id="humidity">--%</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">WIND</div>
          <div class="detail-value" id="wind">-- m/s</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">PRESSURE</div>
          <div class="detail-value" id="pressure">-- hPa</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">VISIBILITY</div>
          <div class="detail-value" id="visibility">-- km</div>
        </div>
      </div>
      
      <div class="air-quality hidden" id="air-quality-container">
        <h3>Air Quality</h3>
        <div class="aqi-meter">
          <div class="aqi-value" id="aqi-value">--</div>
          <div class="aqi-bar">
            <div class="aqi-fill" id="aqi-fill"></div>
          </div>
          <div class="aqi-label" id="aqi-label">--</div>
        </div>
      </div>
    </div>

    <div class="forecast-container hidden" id="forecast-container">
      <!-- Forecast items will be inserted here -->
    </div>
    
    <div class="historical-chart hidden" id="historical-chart-container">
      <h3>Temperature History (24h)</h3>
      <canvas id="temp-chart" width="700" height="300"></canvas>
    </div>

    <div class="location-sharing">
      <button id="get-location" class="location-btn">Use My Location</button>
    </div>

    <div class="theme-toggle">
      <button id="theme-toggle-btn">Toggle Theme</button>
    </div>

    <div class="api-notice">
      <p>Powered by OpenWeatherMap API</p>
    </div>
    
    <!-- Service worker registration notification -->
    <div id="offline-notification" class="hidden">
      App is ready for offline use!
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Your OpenWeatherMap API key - replace with your actual API key
      const apiKey = 'e4c98a93a33eac081ed57dd0a225c826';
      
      // State variables
      let currentUnit = 'celsius';
      let currentWeatherData = null;
      let temperatureHistory = [];
      let historyChart = null;

      // DOM elements
      const cityInput = document.getElementById('city-input');
      const searchButton = document.getElementById('search-button');
      const weatherContainer = document.getElementById('weather-container');
      const forecastContainer = document.getElementById('forecast-container');
      const cityNameElement = document.getElementById('city-name');
      const temperatureElement = document.getElementById('temperature');
      const feelsLikeElement = document.getElementById('feels-like');
      const humidityElement = document.getElementById('humidity');
      const windElement = document.getElementById('wind');
      const pressureElement = document.getElementById('pressure');
      const visibilityElement = document.getElementById('visibility');
      const weatherDescriptionElement = document.getElementById('weather-description');
      const weatherAnimationContainer = document.getElementById('weather-animation');
      const loadingIndicator = document.querySelector('.loading');
      const errorMessage = document.getElementById('error-message');
      const celsiusBtn = document.getElementById('celsius');
      const fahrenheitBtn = document.getElementById('fahrenheit');
      const getLocationBtn = document.getElementById('get-location');
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const airQualityContainer = document.getElementById('air-quality-container');
      const aqiValue = document.getElementById('aqi-value');
      const aqiFill = document.getElementById('aqi-fill');
      const aqiLabel = document.getElementById('aqi-label');
      const historicalChartContainer = document.getElementById('historical-chart-container');
      const tempChartCanvas = document.getElementById('temp-chart');
      const offlineNotification = document.getElementById('offline-notification');

      // Event listeners
      
      // Search button event handler
      searchButton.addEventListener('click', () => {
        const city = cityInput.value.trim();
        if (city) {
          getWeatherData(city);
          // Save to recent searches
          saveRecentSearch(city);
        } else {
          showError("Please enter a city name");
        }
      });

      // Also search when Enter key is pressed
      cityInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
          searchButton.click();
        }
      });
      
      // Temperature unit toggle
      celsiusBtn.addEventListener('click', () => {
        if (currentUnit !== 'celsius') {
          currentUnit = 'celsius';
          celsiusBtn.classList.add('active');
          fahrenheitBtn.classList.remove('active');
          if (currentWeatherData) {
            updateTemperatureDisplay(currentWeatherData);
          }
        }
      });
      
      fahrenheitBtn.addEventListener('click', () => {
        if (currentUnit !== 'fahrenheit') {
          currentUnit = 'fahrenheit';
          fahrenheitBtn.classList.add('active');
          celsiusBtn.classList.remove('active');
          if (currentWeatherData) {
            updateTemperatureDisplay(currentWeatherData);
          }
        }
      });
      
      // Geolocation
      getLocationBtn.addEventListener('click', () => {
        if (navigator.geolocation) {
          getLocationBtn.textContent = "Locating...";
          getLocationBtn.disabled = true;
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              getLocationBtn.textContent = "Use My Location";
              getLocationBtn.disabled = false;
              getWeatherByCoordinates(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
              getLocationBtn.textContent = "Use My Location";
              getLocationBtn.disabled = false;
              showError("Could not get your location: " + error.message);
            }
          );
        } else {
          showError("Geolocation is not supported by your browser");
        }
      });
      
      // Theme toggle
      themeToggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('light-theme');
        const isDarkTheme = !document.body.classList.contains('light-theme');
        localStorage.setItem('darkTheme', isDarkTheme);
        updateChart();
      });
      
      // Load saved theme
      if (localStorage.getItem('darkTheme') === 'false') {
        document.body.classList.add('light-theme');
      }

      // Get weather by coordinates
      async function getWeatherByCoordinates(lat, lon) {
        showLoading();
        
        try {
          const currentWeatherResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
          );
          
          if (!currentWeatherResponse.ok) {
            throw new Error('Weather data unavailable');
          }
          
          const currentWeatherData = await currentWeatherResponse.json();
          
          const forecastResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
          );
          
          if (!forecastResponse.ok) {
            throw new Error('Forecast data unavailable');
          }
          
          const forecastData = await forecastResponse.json();
          
          // Get air quality data
          const airQualityResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`
          );
          
          if (airQualityResponse.ok) {
            const airQualityData = await airQualityResponse.json();
            updateAirQualityUI(airQualityData);
          }
          
          // Get historical data
          getHistoricalData(lat, lon);
          
          // Update UI
          updateWeatherUI(currentWeatherData);
          updateForecastUI(forecastData);
          
          // Show containers
          weatherContainer.classList.remove('hidden');
          forecastContainer.classList.remove('hidden');
          
          hideLoading();
          hideError();
          
          // Set the city input value to the found location
          cityInput.value = currentWeatherData.name;
          
          // Save to recent searches
          saveRecentSearch(currentWeatherData.name);
        } catch (error) {
          hideLoading();
          showError(error.message);
          weatherContainer.classList.add('hidden');
          forecastContainer.classList.add('hidden');
        }
      }
      
      // Get historical weather data for the chart
      async function getHistoricalData(lat, lon) {
        try {
          const now = Math.floor(Date.now() / 1000);
          const oneDayAgo = now - 86400; // 24 hours ago
          
          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/onecall/timemachine?lat=${lat}&lon=${lon}&dt=${oneDayAgo}&appid=${apiKey}&units=metric`
          );
          
          if (!response.ok) {
            historicalChartContainer.classList.add('hidden');
            return;
          }
          
          const data = await response.json();
          
          if (data.hourly && data.hourly.length > 0) {
            temperatureHistory = data.hourly.map(hour => ({
              time: new Date(hour.dt * 1000),
              temp: hour.temp
            }));
            
            // Add current temperature
            if (currentWeatherData) {
              temperatureHistory.push({
                time: new Date(),
                temp: currentWeatherData.main.temp
              });
            }
            
            // Sort by time
            temperatureHistory.sort((a, b) => a.time - b.time);
            
            // Create or update chart
            createOrUpdateChart();
            historicalChartContainer.classList.remove('hidden');
          } else {
            historicalChartContainer.classList.add('hidden');
          }
        } catch (error) {
          console.error('Error fetching historical data:', error);
          historicalChartContainer.classList.add('hidden');
        }
      }

      // Fetch weather data from OpenWeatherMap API
      async function getWeatherData(city) {
        showLoading();

        try {
          // Current weather data
          const currentWeatherResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`
          );
          
          if (!currentWeatherResponse.ok) {
            throw new Error('City not found or API error');
          }
          
          const weatherData = await currentWeatherResponse.json();
          currentWeatherData = weatherData;
          
          // 5-day forecast data
          const forecastResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric`
          );
          
          if (!forecastResponse.ok) {
            throw new Error('Forecast data unavailable');
          }
          
          const forecastData = await forecastResponse.json();
          
          // Get air quality data
          const lat = weatherData.coord.lat;
          const lon = weatherData.coord.lon;
          const airQualityResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`
          );
          
          if (airQualityResponse.ok) {
            const airQualityData = await airQualityResponse.json();
            updateAirQualityUI(airQualityData);
          }
          
          // Get historical data
          getHistoricalData(lat, lon);
          
          // Update UI with the data
          updateWeatherUI(weatherData);
          updateForecastUI(forecastData);
          
          // Show the containers
          weatherContainer.classList.remove('hidden');
          forecastContainer.classList.remove('hidden');
          
          hideLoading();
          hideError();
        } catch (error) {
          hideLoading();
          showError(error.message);
          weatherContainer.classList.add('hidden');
          forecastContainer.classList.add('hidden');
        }
      }

      // Update temperature display based on selected unit
      function updateTemperatureDisplay(data) {
        const tempC = Math.round(data.main.temp);
        const feelsLikeC = Math.round(data.main.feels_like);
        
        if (currentUnit === 'celsius') {
          temperatureElement.textContent = `${tempC}°C`;
          feelsLikeElement.textContent = `Feels like: ${feelsLikeC}°C`;
        } else {
          const tempF = Math.round((tempC * 9/5) + 32);
          const feelsLikeF = Math.round((feelsLikeC * 9/5) + 32);
          temperatureElement.textContent = `${tempF}°F`;
          feelsLikeElement.textContent = `Feels like: ${feelsLikeF}°F`;
        }
      }
      
      // Update air quality UI
      function updateAirQualityUI(data) {
        if (data && data.list && data.list.length > 0) {
          const aqi = data.list[0].main.aqi;
          aqiValue.textContent = aqi;
          
          // AQI is on a scale of 1-5
          // 1: Good, 2: Fair, 3: Moderate, 4: Poor, 5: Very Poor
          // AQI is on a scale of 1-5
          // 1: Good, 2: Fair, 3: Moderate, 4: Poor, 5: Very Poor
          let fillPercent = (aqi / 5) * 100;
          let fillColor, aqiText;
          
          switch (aqi) {
            case 1:
              fillColor = 'var(--success-color)';
              aqiText = 'Good';
              break;
            case 2:
              fillColor = '#97fb57';
              aqiText = 'Fair';
              break;
            case 3:
              fillColor = '#fcdf59';
              aqiText = 'Moderate';
              break;
            case 4:
              fillColor = '#ff9e3d';
              aqiText = 'Poor';
              break;
            case 5:
              fillColor = 'var(--accent-color)';
              aqiText = 'Very Poor';
              break;
            default:
              fillColor = '#8b9bb4';
              aqiText = 'Unknown';
          }
          
          aqiFill.style.width = `${fillPercent}%`;
          aqiFill.style.backgroundColor = fillColor;
          aqiLabel.textContent = aqiText;
          
          airQualityContainer.classList.remove('hidden');
        } else {
          airQualityContainer.classList.add('hidden');
        }
      }
      
      // Create or update temperature history chart
      function createOrUpdateChart() {
        if (!temperatureHistory || temperatureHistory.length === 0) {
          historicalChartContainer.classList.add('hidden');
          return;
        }
        
        const labels = temperatureHistory.map(entry => {
          const hours = entry.time.getHours();
          const minutes = entry.time.getMinutes();
          return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        });
        
        const temps = temperatureHistory.map(entry => {
          if (currentUnit === 'celsius') {
            return entry.temp;
          } else {
            return (entry.temp * 9/5) + 32;
          }
        });
        
        const isDarkTheme = !document.body.classList.contains('light-theme');
        const fontColor = isDarkTheme ? '#eef7fa' : '#181425';
        const gridColor = isDarkTheme ? 'rgba(238, 247, 250, 0.1)' : 'rgba(24, 20, 37, 0.1)';
        
        const chartConfig = {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: `Temperature (°${currentUnit === 'celsius' ? 'C' : 'F'})`,
              data: temps,
              borderColor: '#fcdf59',
              backgroundColor: 'rgba(252, 223, 89, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#fcdf59',
              pointRadius: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  font: {
                    family: "'Press Start 2P', cursive",
                    size: 10
                  },
                  color: fontColor
                }
              },
              tooltip: {
                titleFont: {
                  family: "'Press Start 2P', cursive",
                  size: 10
                },
                bodyFont: {
                  family: "'Press Start 2P', cursive",
                  size: 10
                }
              }
            },
            scales: {
              x: {
                grid: {
                  color: gridColor
                },
                ticks: {
                  font: {
                    family: "'Press Start 2P', cursive",
                    size: 8
                  },
                  color: fontColor,
                  maxRotation: 45,
                  minRotation: 45
                }
              },
              y: {
                grid: {
                  color: gridColor
                },
                ticks: {
                  font: {
                    family: "'Press Start 2P', cursive",
                    size: 10
                  },
                  color: fontColor
                }
              }
            }
          }
        };
        
        if (historyChart) {
          historyChart.data = chartConfig.data;
          historyChart.options = chartConfig.options;
          historyChart.update();
        } else {
          historyChart = new Chart(tempChartCanvas, chartConfig);
        }
      }
      
      // Update chart when theme changes
      function updateChart() {
        if (historyChart) {
          createOrUpdateChart();
        }
      }
      
      // Save recent searches to localStorage
      function saveRecentSearch(city) {
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        
        // Don't add duplicates
        if (!recentSearches.includes(city)) {
          recentSearches.unshift(city);
          
          // Keep only the last 5 searches
          if (recentSearches.length > 5) {
            recentSearches = recentSearches.slice(0, 5);
          }
          
          localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }
      }

      // Update current weather UI
      function updateWeatherUI(data) {
        cityNameElement.textContent = `${data.name}, ${data.sys.country}`;
        updateTemperatureDisplay(data);
        humidityElement.textContent = `${data.main.humidity}%`;
        windElement.textContent = `${data.wind.speed} m/s`;
        pressureElement.textContent = `${data.main.pressure} hPa`;
        visibilityElement.textContent = `${(data.visibility / 1000).toFixed(1)} km`;
        weatherDescriptionElement.textContent = capitalizeFirstLetter(data.weather[0].description);
        
        // Create weather animation
        createWeatherAnimation(data.weather[0].id, data.dt, data.sys.sunrise, data.sys.sunset);
        
        // Update document title
        document.title = `${Math.round(data.main.temp)}°${currentUnit === 'celsius' ? 'C' : 'F'} - ${data.name} | Pixel Weather`;
        
        // Change background color slightly based on temperature
        const temp = data.main.temp;
        let bgHue;
        
        if (temp < 0) {
          bgHue = 240; // Blue for cold
        } else if (temp < 10) {
          bgHue = 200; // Light blue for cool
        } else if (temp < 20) {
          bgHue = 120; // Green for mild
        } else if (temp < 30) {
          bgHue = 60; // Yellow for warm
        } else {
          bgHue = 0; // Red for hot
        }
        
        // Only apply if dark theme is active
        if (!document.body.classList.contains('light-theme')) {
          document.body.style.backgroundColor = `hsl(${bgHue}, 30%, 15%)`;
        }
      }

      // Update forecast UI
      function updateForecastUI(data) {
        forecastContainer.innerHTML = '';
        
        // Group forecast data by day
        const forecastByDay = {};
        const today = new Date().setHours(0, 0, 0, 0);
        
        data.list.forEach(item => {
          const date = new Date(item.dt * 1000);
          const day = date.setHours(0, 0, 0, 0);
          
          // Skip today's forecast
          if (day === today) return;
          
          if (!forecastByDay[day]) {
            forecastByDay[day] = [];
          }
          
          forecastByDay[day].push(item);
        });
        
        // Get next 5 days
        const days = Object.keys(forecastByDay).sort().slice(0, 5);
        
        days.forEach(day => {
          const forecasts = forecastByDay[day];
          if (forecasts.length === 0) return;
          
          // Calculate average temperature and find most common weather condition
          let totalTemp = 0;
          const weatherCounts = {};
          
          forecasts.forEach(item => {
            totalTemp += item.main.temp;
            const weatherId = item.weather[0].id;
            weatherCounts[weatherId] = (weatherCounts[weatherId] || 0) + 1;
          });
          
          const avgTemp = totalTemp / forecasts.length;
          
          // Get most common weather condition
          let mostCommonWeatherId;
          let maxCount = 0;
          
          for (const [weatherId, count] of Object.entries(weatherCounts)) {
            if (count > maxCount) {
              maxCount = count;
              mostCommonWeatherId = parseInt(weatherId);
            }
          }
          
          const date = new Date(parseInt(day));
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          const dayNum = date.getDate();
          
          const forecastItem = document.createElement('div');
          forecastItem.className = 'forecast-item';
          
          const forecastIcon = document.createElement('div');
          forecastIcon.className = 'forecast-icon';
          createMiniWeatherAnimation(forecastIcon, mostCommonWeatherId, 12 * 3600); // Noon
          
          const tempDisplay = currentUnit === 'celsius' ? 
                              `${Math.round(avgTemp)}°C` : 
                              `${Math.round((avgTemp * 9/5) + 32)}°F`;
          
          forecastItem.innerHTML = `
            <div class="forecast-day">${dayName} ${dayNum}</div>
            <div class="forecast-temp">${tempDisplay}</div>
          `;
          
          forecastItem.appendChild(forecastIcon);
          forecastContainer.appendChild(forecastItem);
        });
      }

      // Create weather animation based on weather code and time
      function createWeatherAnimation(weatherCode, currentTime, sunriseTime, sunsetTime) {
        // Clear previous animation
        weatherAnimationContainer.innerHTML = '';
        
        // Check if it's day or night
        const isDay = currentTime >= sunriseTime && currentTime < sunsetTime;
        
        // Create background based on time of day
        if (isDay) {
          const sun = document.createElement('div');
          sun.className = 'sun';
          weatherAnimationContainer.appendChild(sun);
        } else {
          const moon = document.createElement('div');
          moon.className = 'moon';
          weatherAnimationContainer.appendChild(moon);
          
          // Add stars
          for (let i = 0; i < 15; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 2}s`;
            weatherAnimationContainer.appendChild(star);
          }
        }
        
        // Weather code logic
        // 2xx: Thunderstorm
        // 3xx: Drizzle
        // 5xx: Rain
        // 6xx: Snow
        // 7xx: Atmosphere (fog, haze, etc.)
        // 800: Clear sky
        // 80x: Clouds
        
        if (weatherCode >= 200 && weatherCode < 300) {
          // Thunderstorm
          createCloud();
          createRain(10);
          // Add lightning flash animation
          weatherAnimationContainer.style.animation = 'flash 4s infinite';
          
          // Define flash animation
          const style = document.createElement('style');
          style.textContent = `
            @keyframes flash {
              0%, 95%, 98% {
                background-color: transparent;
              }
              96%, 99% {
                background-color: rgba(255, 255, 255, 0.8);
              }
            }
          `;
          document.head.appendChild(style);
        } 
        else if ((weatherCode >= 300 && weatherCode < 400) || 
                (weatherCode >= 500 && weatherCode < 600)) {
          // Drizzle and Rain
          createCloud();
          const intensity = weatherCode >= 500 ? 15 : 7;
          createRain(intensity);
        } 
        else if (weatherCode >= 600 && weatherCode < 700) {
          // Snow
          createCloud();
          createSnow(15);
        } 
        else if (weatherCode >= 700 && weatherCode < 800) {
          // Atmosphere (fog, haze, etc.)
          const fog = document.createElement('div');
          fog.style.position = 'absolute';
          fog.style.width = '100%';
          fog.style.height = '100%';
          fog.style.backgroundColor = 'rgba(200, 200, 200, 0.5)';
          weatherAnimationContainer.appendChild(fog);
        } 
        else if (weatherCode === 800) {
          // Clear sky - already created sun/moon
        } 
        else if (weatherCode > 800 && weatherCode < 900) {
          // Clouds
          const cloudCount = weatherCode - 800;
          for (let i = 0; i < cloudCount; i++) {
            createCloud(i * 20);
          }
        }
      }
      
      // Create mini weather animation for forecast
      function createMiniWeatherAnimation(container, weatherCode, time) {
        // Simplified version for the forecast icons
        if (weatherCode >= 200 && weatherCode < 300) {
          // Thunderstorm
          const cloud = document.createElement('div');
          cloud.className = 'cloud';
          cloud.style.transform = 'scale(0.5)';
          cloud.style.top = '5px';
          container.appendChild(cloud);
        } 
        else if ((weatherCode >= 300 && weatherCode < 400) || 
                (weatherCode >= 500 && weatherCode < 600)) {
          // Rain
          const cloud = document.createElement('div');
          cloud.className = 'cloud';
          cloud.style.transform = 'scale(0.5)';
          cloud.style.top = '5px';
          container.appendChild(cloud);
          
          // Add a few raindrops
          for (let i = 0; i < 3; i++) {
            const raindrop = document.createElement('div');
            raindrop.className = 'raindrop';
            raindrop.style.left = `${10 + i * 10}px`;
            raindrop.style.top = '20px';
            raindrop.style.animationDuration = '0.7s';
            container.appendChild(raindrop);
          }
        } 
        else if (weatherCode >= 600 && weatherCode < 700) {
          // Snow
          const cloud = document.createElement('div');
          cloud.className = 'cloud';
          cloud.style.transform = 'scale(0.5)';
          cloud.style.top = '5px';
          container.appendChild(cloud);
          
          // Add a few snowflakes
          for (let i = 0; i < 3; i++) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.style.left = `${10 + i * 10}px`;
            snowflake.style.top = '20px';
            snowflake.style.animationDuration = '2s';
            container.appendChild(snowflake);
          }
        } 
        else if (weatherCode === 800) {
          // Clear sky
          const sun = document.createElement('div');
          sun.className = 'sun';
          sun.style.transform = 'scale(0.5)';
          sun.style.top = '5px';
          sun.style.left = '5px';
          container.appendChild(sun);
        } 
        else if (weatherCode > 800 && weatherCode < 900) {
          // Clouds
          const cloud = document.createElement('div');
          cloud.className = 'cloud';
          cloud.style.transform = 'scale(0.5)';
          cloud.style.top = '5px';
          container.appendChild(cloud);
        }
      }
      
      // Helper function to create rain effect
      function createRain(dropCount) {
        for (let i = 0; i < dropCount; i++) {
          const raindrop = document.createElement('div');
          raindrop.className = 'raindrop';
          raindrop.style.left = `${Math.random() * 100}%`;
          raindrop.style.animationDelay = `${Math.random() * 1}s`;
          raindrop.style.animationDuration = `${0.5 + Math.random() * 0.5}s`;
          weatherAnimationContainer.appendChild(raindrop);
        }
      }
      
      // Helper function to create snow effect
      function createSnow(flakeCount) {
        for (let i = 0; i < flakeCount; i++) {
          const snowflake = document.createElement('div');
          snowflake.className = 'snowflake';
          snowflake.style.left = `${Math.random() * 100}%`;
          snowflake.style.animationDelay = `${Math.random() * 4}s`;
          snowflake.style.animationDuration = `${3 + Math.random() * 3}s`;
          weatherAnimationContainer.appendChild(snowflake);
        }
      }
      
      // Helper function to create cloud
      function createCloud(leftOffset = 0) {
        const cloud = document.createElement('div');
        cloud.className = 'cloud';
        cloud.style.left = `${(30 + leftOffset) % 80}px`;
        weatherAnimationContainer.appendChild(cloud);
      }

      // Helper functions
      function showLoading() {
        loadingIndicator.style.display = 'block';
      }
      
      function hideLoading() {
        loadingIndicator.style.display = 'none';
      }
      
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
      }
      
      function hideError() {
        errorMessage.style.display = 'none';
      }
      
      function showMessage(message) {
        errorMessage.textContent = message;
        errorMessage.style.color = 'var(--success-color)';
        errorMessage.style.display = 'block';
        setTimeout(() => {
          hideError();
          errorMessage.style.color = 'var(--accent-color)';
        }, 3000);
      }
      
      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      
      // Register service worker for offline support
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('weather-sw.js').then(registration => {
            console.log('ServiceWorker registration successful');
            offlineNotification.classList.remove('hidden');
            setTimeout(() => {
              offlineNotification.classList.add('hidden');
            }, 3000);
          }).catch(error => {
            console.log('ServiceWorker registration failed:', error);
          });
        });
      }
      
      // Initialize app - check for recent searches
      function initApp() {
        const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        if (recentSearches.length > 0) {
          getWeatherData(recentSearches[0]);
        }
      }
      
      // Call init
      initApp();
    });
  </script>
</body>
</html>